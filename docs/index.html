<html>
<head>
	<title>Prever Perda de Peso</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<link rel="stylesheet" href="assets/css/main.css" />
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

	<style>
		/* Garante que o menu está sempre visível no lado esquerdo */
		#sidebar {
			position: fixed;
			left: 0;
			top: 0;
			height: 100vh;
			width: 250px;
			background: #f7f7f7;
			z-index: 9999;
			overflow-y: auto;
			transform: none !important;
			box-shadow: 2px 0 6px rgba(0,0,0,0.1);
		}

		/* Move o conteúdo principal para a direita para não ficar escondido */
		#main {
			margin-left: 250px;
		}

		/* Remove efeitos de esconder o menu (caso body tenha a classe .is-menu-visible) */
		body.is-menu-visible #sidebar {
			transform: none !important;
		}
	</style>

</head>


<body class="is-preload">

	<!-- Wrapper -->
	<div id="wrapper">
		<!-- Main -->
		<div id="main">
			<div class="inner">

				<!-- Header -->
				<header id="header">
					<a href="index.html" class="logo" style="font-family: Arial, sans-serif;">
						<h1 style="margin-bottom: 1px;">Previsão de peso</h1>
						<p style="font-size: 1.2em; margin-bottom: 0; color: #555;">
							após cirurgia de sleeve gástrico
						</p>
					</a>
				</header>

				<!-- Banner -->
				<section id="banner">
					<div class="content">
						<form id="formularioPrincipal" onsubmit="return false;">


							<div style="display:flex; gap: 40px; flex-wrap: wrap; margin-bottom: 32px;">
								<!-- Coluna da esquerda -->
								<div style="flex: 1; min-width: 280px;">
									<!-- Género -->
									<div style="margin-bottom: 16px;">
										<h2 style="display: inline-block; border-bottom: 2px solid #0074D9; padding-bottom: 4px;">Sexo Biológico:</h2><br>
										<input type="radio" id="masculino" name="genero" value="masculino">
										<label for="masculino" style="margin-right: 20px;">Masculino</label>
										<input type="radio" id="feminino" name="genero" value="feminino">
										<label for="feminino">Feminino</label>
									</div>

									<!-- Ano da cirurgia -->
									<div style="margin-bottom: 16px;">
										<h2 style="display: inline-block; border-bottom: 2px solid #0074D9; padding-bottom: 4px;">Ano da cirurgia:</h2>
										<select id="anoCirurgia" name="anoCirurgia" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
											<option value="" disabled selected>Selecione o ano</option>
										</select>
										<div id="erroAnoCirurgia" style="display:none; color: #e74c3c; font-size: 0.9em; margin-top: 4px;">
											A data da cirurgia deve ser posterior à data de nascimento.
										</div>
									</div>


									<!-- Peso -->
									<div style="margin-bottom: 16px;">
										<h2 style="display: inline-block; border-bottom: 2px solid #0074D9; padding-bottom: 4px;">Peso à data da cirurgia [kg]:</h2>
										<input type="text" id="peso" name="peso" step="0.01" min="0.01"
											   placeholder="Inserir peso"
											   style="width: 100%; border: 1px solid #ccc; padding: 8px; border-radius: 4px;">
										<span style="font-size: 0.9em; color: #666;">Utilize ponto como separador decimal (ex: 60.5)</span>
										<div id="erroPeso" style="display:none; color: #e74c3c; font-size: 0.9em; margin-top: 4px;">
											Utilize ponto (.) como separador decimal, não vírgula (,).
										</div>
									</div>


									<!-- Altura -->
									<div style="margin-bottom: 16px;">
										<h2 style="display: inline-block; border-bottom: 2px solid #0074D9; padding-bottom: 4px;">Altura [m]:</h2>
										<input type="text" id="altura" name="altura" step="0.01" min="0.01"
											   placeholder="Inserir altura"
											   style="width: 100%; border: 1px solid #ccc; padding: 8px; border-radius: 4px;">
										<span style="font-size: 0.9em; color: #666;">Utilize ponto como separador decimal (ex: 1.75)</span>
										<div id="erroAltura" style="display:none; color: #e74c3c; font-size: 0.9em; margin-top: 4px;">
											Utilize ponto (.) como separador decimal, não vírgula (,).
										</div>
									</div>


								</div>

								<!-- Coluna da direita -->
								<div style="flex: 1; min-width: 280px;">
									<!-- Data de nascimento -->
									<div style="margin-bottom: 16px;">
										<h2 style="display: inline-block; border-bottom: 2px solid #0074D9; padding-bottom: 4px;">Data de Nascimento:</h2><br>
										<input type="date" id="dataNascimento" name="dataNascimento"> <br>
									</div>

									<!-- Mês da cirurgia -->
									<div style="margin-bottom: 16px;">
										<h2 style="display: inline-block; border-bottom: 2px solid #0074D9; padding-bottom: 4px;">Mês da cirurgia:</h2>
										<select id="mesCirurgia" name="mesCirurgia" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
											<option value="" disabled selected>Selecione o mês</option>
											<option value="janeiro">Janeiro</option>
											<option value="fevereiro">Fevereiro</option>
											<option value="marco">Março</option>
											<option value="abril">Abril</option>
											<option value="maio">Maio</option>
											<option value="junho">Junho</option>
											<option value="julho">Julho</option>
											<option value="agosto">Agosto</option>
											<option value="setembro">Setembro</option>
											<option value="outubro">Outubro</option>
											<option value="novembro">Novembro</option>
											<option value="dezembro">Dezembro</option>
										</select>
										<div id="erroDataCirurgia" style="display:none; color: #e74c3c; font-size: 0.9em; margin-top: 4px;">
											A data da cirurgia deve ser posterior à data de nascimento.
										</div>
									</div>

									<!-- Peso Máximo-->
									<div style="margin-bottom: 16px;">
										<h2 style="display: inline-block; border-bottom: 2px solid #0074D9; padding-bottom: 4px;">Peso Máximo [kg]:</h2>
										<input type="text" id="peso_max" name="peso_max" step="0.01" min="0.01"
											   placeholder="Inserir peso máximo"
											   style="width: 100%; border: 1px solid #ccc; padding: 8px; border-radius: 4px;">
										<span style="font-size: 0.9em; color: #666;">Utilize ponto como separador decimal (ex: 60.5)</span>
										<div id="erroPesoMax" style="display:none; color: #e74c3c; font-size: 0.9em; margin-top: 4px;">
											Utilize ponto (.) como separador decimal, não vírgula (,).
										</div>
									</div>
								</div>
							</div>


							<!-- Resultados IMC, IBW, EBW -->
							<div id="resultadosIMC" style="display:none; margin-bottom: 16px;">
								<!-- Caixa colorida para IMC -->
								<div id="imcBox" style="padding: 16px; border-radius: 8px; color: #fff; font-weight: bold; margin-bottom: 8px;">
									IMC: <span id="imcValor"></span> kg/m<sup>2</sup>
									<span id="imcClasse" style="margin-left: 12px;"></span>
								</div>
								<!-- Caixa branca para IBW -->
								<div style="padding: 16px; border-radius: 8px; background: #fff; color: #222; font-weight: bold; margin-bottom: 8px; border: 1px solid #ccc;">
									Peso Ideal (IBW): <span id="ibwValor"></span> kg
								</div>
								<!-- Caixa branca para EBW -->
								<div style="padding: 16px; border-radius: 8px; background: #fff; color: #222; font-weight: bold; border: 1px solid #ccc;">
									Excesso de Peso (EBW): <span id="ebwValor"></span> kg
								</div>
							</div>

						

							<!-- Antecedentes Pessoais -->
							<div style="margin-bottom: 16px;">
								<section>
									<header class="major">
										<h2>Antecedentes pessoais do paciente (assinale "sim" ou "não"):</h2>
									</header>
									<div class="row">
										<!-- Primeira coluna -->
										<div class="col-6 col-12-medium">
											<p>
												<strong>
													Diabetes Mellitus
													<span title="Doença metabólica caracterizada por níveis elevados de açúcar no sangue." style="cursor: pointer; font-size: 0.9em; color: #0074D9; margin-left:4px;">&#9432;</span>
												</strong><br>
												<input type="radio" id="diabetesSim" name="diabetes" value="sim">
												<label for="diabetesSim">Sim</label>
												<input type="radio" id="diabetesNao" name="diabetes" value="nao">
												<label for="diabetesNao">Não</label>

											</p>

											<p>
												<strong>
													Hipertensão Arterial (HTA)
													<span title="Pressão arterial elevada, fator de risco para doenças cardiovasculares." style="cursor: pointer; font-size: 0.9em; color: #0074D9; margin-left:4px;">&#9432;</span>
												</strong><br>
												<input type="radio" id="htaSim" name="hta" value="sim">
												<label for="htaSim">Sim</label>
												<input type="radio" id="htaNao" name="hta" value="nao">
												<label for="htaNao">Não</label>
											</p>

											<p>
												<strong>
													Síndrome de Apneia do Sono (SAOS/DPOC)
													<span title="Distúrbios respiratórios durante o sono, como apneia obstrutiva ou doença pulmonar crónica." style="cursor: pointer; font-size: 0.9em; color: #0074D9; margin-left:4px;">&#9432;</span>
												</strong><br>
												<input type="radio" id="sonoSim" name="sono" value="sim">
												<label for="sonoSim">Sim</label>
												<input type="radio" id="sonoNao" name="sono" value="nao">
												<label for="sonoNao">Não</label>
											</p>

											<p>
												<strong>
													Dislipidemia
													<span title="Alteração dos níveis de gordura (colesterol, triglicerídeos) no sangue." style="cursor: pointer; font-size: 0.9em; color: #0074D9; margin-left:4px;">&#9432;</span>
												</strong><br>
												<input type="radio" id="dislipidemiaSim" name="dislipidemia" value="sim">
												<label for="dislipidemiaSim">Sim</label>
												<input type="radio" id="dislipidemiaNao" name="dislipidemia" value="nao">
												<label for="dislipidemiaNao">Não</label>
											</p>

											<p>
												<strong>
													Cardiopatia
													<span title="Doença que afeta o coração, como insuficiência cardíaca ou arritmias." style="cursor: pointer; font-size: 0.9em; color: #0074D9; margin-left:4px;">&#9432;</span>
												</strong><br>
												<input type="radio" id="cardiopatiaSim" name="cardiopatia" value="sim">
												<label for="cardiopatiaSim">Sim</label>
												<input type="radio" id="cardiopatiaNao" name="cardiopatia" value="nao">
												<label for="cardiopatiaNao">Não</label>
											</p>
										</div>

										<!-- Segunda coluna -->
										<div class="col-6 col-12-medium">
											<p>
												<strong>
													Perturbação Psiquiátrica
													<span title="Diagnóstico de doença mental, como depressão, ansiedade, esquizofrenia, etc." style="cursor: pointer; font-size: 0.9em; color: #0074D9; margin-left:4px;">&#9432;</span>
												</strong><br>
												<input type="radio" id="psiquiatricaSim" name="psiquiatrica" value="sim">
												<label for="psiquiatricaSim">Sim</label>
												<input type="radio" id="psiquiatricaNao" name="psiquiatrica" value="nao">
												<label for="psiquiatricaNao">Não</label>
											</p>

											<p>
												<strong>
													Doenças Osteomusculares
													<span title="Doenças que afetam ossos, articulações ou músculos, como artrose ou artrite." style="cursor: pointer; font-size: 0.9em; color: #0074D9; margin-left:4px;">&#9432;</span>
												</strong><br>
												<input type="radio" id="osteomuscularSim" name="osteomuscular" value="sim">
												<label for="osteomuscularSim">Sim</label>
												<input type="radio" id="osteomuscularNao" name="osteomuscular" value="nao">
												<label for="osteomuscularNao">Não</label>
											</p>

											<p>
												<strong>
													Doença do Refluxo Gastroesofágico (DRGE)
													<span title="Refluxo ácido do estômago para o esófago, causando azia e desconforto." style="cursor: pointer; font-size: 0.9em; color: #0074D9; margin-left:4px;">&#9432;</span>
												</strong><br>
												<input type="radio" id="drgeSim" name="drge" value="sim">
												<label for="drgeSim">Sim</label>
												<input type="radio" id="drgeNao" name="drge" value="nao">
												<label for="drgeNao">Não</label>
											</p>

											<p>
												<strong>
													Hiperuricemia
													<span title="Níveis elevados de ácido úrico no sangue, podendo causar gota." style="cursor: pointer; font-size: 0.9em; color: #0074D9; margin-left:4px;">&#9432;</span>
												</strong><br>
												<input type="radio" id="hiperuricemiaSim" name="hiperuricemia" value="sim">
												<label for="hiperuricemiaSim">Sim</label>
												<input type="radio" id="hiperuricemiaNao" name="hiperuricemia" value="nao">
												<label for="hiperuricemiaNao">Não</label>
											</p>

											<p>
												<strong>
													Terapêutica com insulina?
													<span title="Necessidade de usar insulina para controlar a diabetes." style="cursor: pointer; font-size: 0.9em; color: #0074D9; margin-left:4px;">&#9432;</span>
												</strong><br>
												<input type="radio" id="insulinaSim" name="insulina" value="sim">
												<label for="insulinaSim">Sim</label>
												<input type="radio" id="insulinaNao" name="insulina" value="nao">
												<label for="insulinaNao">Não</label>
											</p>
										</div>
									</div>
								</section>
							</div>
							<!-- Realizou cirurgia -->
							<!-- Realizou cirurgia -->
							<div style="margin-bottom: 16px;">
								<label>
									<header class="major">
										<h2>Já realizou a cirurgia?</h2>
									</header>
									<input type="radio" id="cirurgiaSim" name="cirurgiaRealizada" value="sim">
									<label for="cirurgiaSim">Sim</label><br>
									<input type="radio" id="cirurgiaNao" name="cirurgiaRealizada" value="nao">
									<label for="cirurgiaNao">Não</label>
							</div>

							<!-- Campos adicionais -->
							<div id="camposAdicionais" style="display:none; margin-bottom: 16px;">
								<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">

									<!-- Primeira coluna -->
									<div style="display: flex; flex-direction: column; gap: 16px;">
										<!-- Peso aos 3 meses -->
										<div style="margin-bottom: 12px;">
											<label for="peso3meses"><strong>Peso aos 3 meses (kg):</strong></label>
											<input type="text" id="peso3meses" style="width: 100%;">
										</div>

										<!-- Mensagem de erro para peso aos 3 meses -->
										<div id="erroPeso3meses" style="display:none; color: #e74c3c; font-size: 0.9em; margin-top: 4px;">
											Utilize ponto (.) como separador decimal, não vírgula (,).
										</div>



										<!-- Peso aos 12 meses -->
										<div id="peso12mesesDiv" style="display:none;">
											<label for="peso12meses"><strong>Peso aos 12 meses (kg):</strong></label>
											<input type="text" id="peso12meses" style="width: 100%;">
										</div>
										<!-- Mensagem de erro para peso aos 12 meses -->
										<div id="erroPeso12meses" style="display:none; color: #e74c3c; font-size: 0.9em; margin-top: 4px;">
											Utilize ponto (.) como separador decimal, não vírgula (,).
										</div>


										<!-- Peso aos 36 meses -->
										<div id="peso36mesesDiv" style="display:none;">
											<label for="peso36meses"><strong>Peso aos 36 meses (kg):</strong></label>
											<input type="text" id="peso36meses" style="width: 100%;">
										</div>
										<!-- Mensagem de erro para peso aos 36 meses -->
										<div id="erroPeso36meses" style="display:none; color: #e74c3c; font-size: 0.9em; margin-top: 4px;">
											Utilize ponto (.) como separador decimal, não vírgula (,).
										</div>


										<!-- Peso aos 60 meses -->
										<div id="peso60mesesDiv" style="display:none;">
											<label for="peso60meses"><strong>Peso aos 60 meses (kg):</strong></label>
											<input type="text" id="peso60meses" style="width: 100%;">
										</div>
										<!-- Mensagem de erro para peso aos 60 meses -->
										<div id="erroPeso60meses" style="display:none; color: #e74c3c; font-size: 0.9em; margin-top: 4px;">
											Utilize ponto (.) como separador decimal, não vírgula (,).
										</div>



									</div>

									<!-- Segunda coluna -->
									<div style="display: flex; flex-direction: column; gap: 16px;">
										<!-- Peso aos 6 meses -->
										<div id="peso6mesesDiv" style="display:none;">
											<label for="peso6meses"><strong>Peso aos 6 meses (kg):</strong></label>
											<input type="text" id="peso6meses" placeholder="Ex: 85.5" style="width: 100%;">
										</div>
										<!-- Mensagem de erro para peso aos 6 meses -->
										<div id="erroPeso6meses" style="display:none; color: #e74c3c; font-size: 0.9em; margin-top: 4px;">
											Utilize ponto (.) como separador decimal, não vírgula (,).
										</div>


										<!-- Peso aos 24 meses -->
										<div id="peso24mesesDiv" style="display:none;">
											<label for="peso24meses"><strong>Peso aos 24 meses (kg):</strong></label>
											<input type="text" id="peso24meses" placeholder="Ex: 75.5" style="width: 100%;">
										</div>
										<!-- Mensagem de erro para peso aos 24 meses -->
										<div id="erroPeso24meses" style="display:none; color: #e74c3c; font-size: 0.9em; margin-top: 4px;">
											Utilize ponto (.) como separador decimal, não vírgula (,).
										</div>


										<!-- Peso aos 48 meses -->
										<div id="peso48mesesDiv" style="display:none;">
											<label for="peso48meses"><strong>Peso aos 48 meses (kg):</strong></label>
											<input type="text" id="peso48meses" placeholder="Ex: 73.0" style="width: 100%;">
										</div>
										<!-- Mensagem de erro para peso aos 48 meses -->
										<div id="erroPeso48meses" style="display:none; color: #e74c3c; font-size: 0.9em; margin-top: 4px;">
											Utilize ponto (.) como separador decimal, não vírgula (,).
										</div>

									</div>

								</div>
							</div>
</section>

				<!-- Mensagem de erro -->
				<div id="mensagemErro" style="display:none; color: #fff; background: #e74c3c; border-radius: 6px; padding: 10px; margin-bottom: 16px; font-weight: bold; text-align: center;">
					Por favor, preencha todos os campos antes de calcular.
				</div>

				<!-- Botão-->
				<button id="calcularBtn" type="button"
						style="background-color: rgb(250, 250, 251); color: rgb(12, 58, 223); padding: 12px 24px; font-weight: bold;
									text-align: center; border: none; border-radius: 6px; cursor: pointer;
									display: flex; justify-content: center; align-items: center;
									font-size: 16px; margin-top: 20px;">
					CALCULAR
				</button><br>

				<!-- Mensagem de erro para IMC insuficiente -->
				<div id="erroIMCInicial" style="display:none; color: #fff; background: #e74c3c; border-radius: 6px; padding: 10px; margin-bottom: 16px; font-weight: bold; text-align: center;">
					IMC abaixo do valor de referência para operar (mínimo 30 kg/m²)
				</div>
				</form>

				<div id="resultado" style="margin-top: 30px; display: none;">
					<h3>Resultados:</h3>
					<h2 style="margin-top: 20px;">Evolução do peso ao longo do tempo</h2>
					<canvas id="graficoPeso" width="600" height="300"></canvas>
					<h2 style="margin-top: 20px;">Evolução do IMC ao longo do tempo</h2>
					<canvas id="graficoIMC" width="600" height="300"></canvas>
				</div>
				</section>
			</div>
		</div>

		<script>
			function calcularEMostrarIMC() {


				const peso = parseFloat(document.getElementById("peso").value);
				const altura = parseFloat(document.getElementById("altura").value);
				const genero = document.querySelector('input[name="genero"]:checked');
                const erroIMC = document.getElementById("erroIMCInicial");

				if (!peso || !altura || !genero) {
					document.getElementById("resultadosIMC").style.display = "none";
                    erroIMC.style.display = "none";
					return;
				}

				const imc = peso / (altura ** 2);

                if (imc < 30) {
                    erroIMC.style.display = "block";
                    document.getElementById("resultado").style.display = "none";
                } else {
                    erroIMC.style.display = "none";
				}

				let classe = "";
				let cor = "";

				if (imc < 18.5) {
					classe = "Abaixo do peso"; cor = "#f1c40f";
				} else if (imc < 25) {
					classe = "Normal"; cor = "#27ae60";
				} else if (imc < 30) {
					classe = "Acima do peso"; cor = "#f39c12";
				} else if (imc < 35) {
					classe = "Obesidade grau 1"; cor = "#e74c3c";
				} else if (imc < 40) {
					classe = "Obesidade grau 2"; cor = "#c0392b";
				} else {
					classe = "Obesidade grau 3"; cor = "#7f0000";
				}

				// IBW
				const alturaPolegadas = altura / 0.0254;
				let ibw = 0;
				if (genero.value === "masculino") {
					ibw = 50 + 2.3 * (alturaPolegadas - 60);
				} else {
					ibw = 45.5 + 2.3 * (alturaPolegadas - 60);
				}

				const ebw = peso - ibw;

				// Atualizar interface
				document.getElementById("resultadosIMC").style.display = "block";
				document.getElementById("imcValor").innerText = imc.toFixed(2);
				document.getElementById("imcClasse").innerText = classe;
				document.getElementById("imcBox").style.backgroundColor = cor;
				document.getElementById("ibwValor").innerText = ibw.toFixed(1);
				document.getElementById("ebwValor").innerText = ebw.toFixed(1);
			}

			// Atualizar ao digitar
			document.getElementById("peso").addEventListener("input", calcularEMostrarIMC);
			document.getElementById("altura").addEventListener("input", calcularEMostrarIMC);
			document.querySelectorAll('input[name="genero"]').forEach(input =>
				input.addEventListener("change", calcularEMostrarIMC)
			);
		</script>


		<!-- Função para mostrar o gráfico -->
		<script>
			let chartPeso = null;
			let chartIMC = null;
			function mostrarGraficoPesos(labels, pesosProj, pesoInicial, altura) {
				if (chartPeso) {
					chartPeso.destroy();
				}
				if (chartIMC) {
					chartIMC.destroy();
				}
			const twlArray = pesosProj.map(p => ((pesoInicial - p) / pesoInicial * 100).toFixed(1));
			const imcArray = pesosProj.map(p => (p / (altura ** 2)).toFixed(2));
			const classeIMCArray = imcArray.map(imc => {
				imc = parseFloat(imc);
				if (imc < 18.5) return "Abaixo do peso";
				if (imc < 25) return "Normal";
				if (imc < 30) return "Acima de peso";
				if (imc < 35) return "Obesidade grau 1";
				if (imc < 40) return "Obesidade grau 2";
				return "Obesidade grau 3";
			});
			const corClasseIMC = imcArray.map(imc => {
				imc = parseFloat(imc);
				if (imc < 18.5) return "#f1c40f"; // amarelo
				if (imc < 25) return "#27ae60"; // verde
				if (imc < 30) return "#f39c12"; // laranja
				if (imc < 35) return "#e74c3c"; // vermelho claro
				if (imc < 40) return "#c0392b"; // vermelho escuro
				return "#7f0000"; // vinho
			});

			const ctx = document.getElementById('graficoPeso').getContext('2d');
			const mesesX = [0, 3, 6, 12, 24, 36, 48, 60];  // Meses definidos

			const dadosPesoXY = mesesX.map((mes, i) => ({
				x: mes,
				y: pesosProj[i]
			}));

			chartPeso = new Chart(ctx, {
				type: 'line',
				data: {
					datasets: [{
						data: dadosPesoXY,
						borderColor: 'gray',
						backgroundColor: 'transparent',
						fill: false,
						tension: 0.3,
						pointRadius: 5,
						pointBackgroundColor: corClasseIMC, // Cor dinâmica nos pontos
						pointBorderColor: corClasseIMC      // Borda igual à cor de fundo
					}]
				},
				options: {
					responsive: true,
					plugins: {
						legend: {
							display: false // Desativa completamente a legenda
						},
						tooltip: {
							usePointStyle: false,
							displayColors: false, // Remove o quadrado de cor
							backgroundColor: function (context) {
								const i = context.tooltip.dataPoints[0].dataIndex;
								return corClasseIMC[i]; // Usa o array de cores por IMC
							},
							callbacks: {
								title: function (context) {
									const index = context[0].dataIndex;
									const meses = [0, 3, 6, 12, 24, 36, 48, 60];
									return `${meses[index]} meses`;
								},
								label: function (context) {
									const i = context.dataIndex;
									return [
										`Peso: ${pesosProj[i]} kg`,
										`TWL: ${twlArray[i]} %`,
										`IMC: ${imcArray[i]} kg / m²`,
										`Classe: ${classeIMCArray[i]}`
									];
								}
							}
						}
					},
					scales: {
						x: {
							type: 'linear', // Eixo X do tipo linear
							title: {
								display: true,
								text: 'Meses após cirurgia'
							},
							ticks: {
								callback: function(value) {
									switch(value) {
										case 0: return '0 meses';
										case 3: return '3 meses';
										case 6: return '6 meses';
										case 12: return '12 meses';
										case 24: return '24 meses';
										case 36: return '36 meses';
										case 48: return '48 meses';
										case 60: return '60 meses';
										default: return ''; // Caso de valores não esperados (que não são usados)
									}
								},
								stepSize: 3, // Passo de 3 meses entre cada tick
							},
							min: 0,
							max: 60
						},
						y: { 
							beginAtZero: false // Define se o eixo Y começa no 0
						}
					}
				}
			});

				// Criar gráfico de IMC
				const dadosIMC_XY = mesesX.map((mes, i) => ({
				x: mes,
				y: parseFloat(imcArray[i])
				}));

				const ctxIMC = document.getElementById('graficoIMC').getContext('2d');
				chartIMC = new Chart(ctxIMC, {
					type: 'line',
					data: {
					datasets: [{
						label: '',
						data: dadosIMC_XY,
						borderColor: 'gray',
						backgroundColor: 'lightgreen',
						fill: false,
						tension: 0.3,
						pointRadius: 5,
						pointBackgroundColor: corClasseIMC,
						pointBorderColor: corClasseIMC
						}]
					},
					options: {
						responsive: true,
						plugins: {
							legend: { display: false },
							tooltip: {
								usePointStyle: false,
								displayColors: false, // ← isto remove o quadrado
								backgroundColor: function (context) {
									const i = context.tooltip.dataPoints[0].dataIndex;
									return corClasseIMC[i]; // Usa o array de cores por IMC que já tens
								},
								callbacks: {
									title: function (context) {
										const index = context[0].dataIndex;
										const meses = [0, 3, 6, 12, 24, 36, 48, 60];
										return `${meses[index]} meses`;
									},
									label: function (context) {
										const i = context.dataIndex;
										return `IMC:${ imcArray[i] } kg / m² - ${ classeIMCArray[i] }`;
									}
								}
							}
						},
						scales: {
							x: {
								type: 'linear',
								title: {
									display: true,
									text: 'Meses após cirurgia'
								},
								ticks: {
									callback: function(value) {
									switch (value) {
										case 0: return '0 meses';
										case 3: return '3 meses';
										case 6: return '6 meses';
										case 12: return '12 meses';
										case 24: return '24 meses';
										case 36: return '36 meses';
										case 48: return '48 meses';
										case 60: return '60 meses';
										default: return ''; // oculta os restantes
									}
									},
									stepSize: 3 // mostra 0, 3, 6, ... 60
								},
								min: 0,
								max: 60
								},
							y: { beginAtZero: false }
						}
					}
				});
			}
		</script>

		<!-- Sidebar -->
		<div id="sidebar">
			<div class="inner">

				<!-- Menu -->
				<nav id="menu">
					<header class="major">
						<h2>Menu</h2>
					</header>
					<ul>
						<li><a href="index.html">Prever perda de peso</a></li>
						<li><a href="informacoes.html">Informações</a></li>
						<li><a href="sobre.html">Sobre o site</a></li>
					</ul>
				</nav>
			</div>
		</div>

		<!-- Scripts -->
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/browser.min.js"></script>
		<script src="assets/js/breakpoints.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/main.js"></script>



		</script>
		<script>
			document.addEventListener("DOMContentLoaded", function () {
				const selectAno = document.getElementById("anoCirurgia");
				for (let ano = 2000; ano <= 2050; ano++) {
					const option = document.createElement("option");
					option.value = ano;
					option.textContent = ano;
					selectAno.appendChild(option);
				}
			});
		</script>

		<script>
			document.addEventListener("DOMContentLoaded", function () {
				const radios = document.querySelectorAll('input[name="cirurgiaRealizada"]');
				const camposAdicionais = document.getElementById("camposAdicionais");

				radios.forEach(input => {
					input.addEventListener("change", function () {
						if (this.value === "sim") {
							camposAdicionais.style.display = "block";
						} else {
							camposAdicionais.style.display = "none";
						}
					});
				});
			});
		</script>

		<script>
			function mostrarProximoPeso(idAtual, idProximoDiv) {
				const input = document.getElementById(idAtual);
				if (!input) return;

				input.addEventListener("input", function () {
					// Mostra o próximo campo apenas se houver valor e não houver vírgula
					if (this.value && !this.value.includes(",")) {
						document.getElementById(idProximoDiv).style.display = "block";
					} else {
						document.getElementById(idProximoDiv).style.display = "none";
					}
				});
			}

			// Ordem intercalada por meses
			mostrarProximoPeso("peso3meses", "peso6mesesDiv");
			mostrarProximoPeso("peso6meses", "peso12mesesDiv");
			mostrarProximoPeso("peso12meses", "peso24mesesDiv");
			mostrarProximoPeso("peso24meses", "peso36mesesDiv");
			mostrarProximoPeso("peso36meses", "peso48mesesDiv");
			mostrarProximoPeso("peso48meses", "peso60mesesDiv");
		</script>

		<script>
			// Lista dos ids dos campos que não podem ter vírgulas
			const camposNumericos = [
				"peso", "peso_max", "altura", "peso3meses", "peso6meses", "peso12meses",
				"peso24meses", "peso36meses", "peso48meses", "peso60meses"
			];

			// Função para validar um campo e mostrar o erro
			function validarCampo(id) {
				const campo = document.getElementById(id);
				// O id do erro é "erro" + primeira letra maiúscula + resto do id
				// Ex: "altura" → "erroAltura", "peso_max" → "erroPesoMax", "peso3meses" → "erroPeso3meses"
				let erroId = "erro" + id.charAt(0).toUpperCase() + id.slice(1);
				if (id === "peso_max") erroId = "erroPesoMax";
				const erro = document.getElementById(erroId);
				if (!campo || !erro) return;

				if (campo.value.includes(",")) {
					erro.style.display = "block";
					campo.style.borderColor = "#e74c3c"; // Destaca o campo com erro
				} else {
					erro.style.display = "none";
					campo.style.borderColor = "#ccc"; // Volta ao normal
				}
			}

			// Adiciona o evento de input a todos os campos
			camposNumericos.forEach(id => {
				const campo = document.getElementById(id);
				if (campo) {
					campo.addEventListener("input", function () {
						validarCampo(id);
					});
				}
			});

			// Validação inicial ao carregar a página
			document.addEventListener("DOMContentLoaded", function () {
				camposNumericos.forEach(id => validarCampo(id));
			});
		</script>

		<script>
			document.addEventListener("DOMContentLoaded", function () {
				const meses = {
					"janeiro": 0, "fevereiro": 1, "marco": 2, "abril": 3,
					"maio": 4, "junho": 5, "julho": 6, "agosto": 7,
					"setembro": 8, "outubro": 9, "novembro": 10, "dezembro": 11
				};

				function validarDatas() {
					const dataNasc = new Date(document.getElementById("dataNascimento").value);
					const anoCirurgia = document.getElementById("anoCirurgia").value;
					const mesCirurgia = document.getElementById("mesCirurgia").value;
					const erroData = document.getElementById("erroDataCirurgia");
					const erroAno = document.getElementById("erroAnoCirurgia");

					if (!dataNasc || !anoCirurgia || !mesCirurgia) return;

					const dataCirurgia = new Date(anoCirurgia, meses[mesCirurgia], 1);

					if (dataCirurgia <= dataNasc) {
						erroData.style.display = "block";
						erroAno.style.display = "block";
						document.getElementById("calcularBtn").disabled = true;
					} else {
						erroData.style.display = "none";
						erroAno.style.display = "none";
						document.getElementById("calcularBtn").disabled = false;
					}
				}

				// Adicionar eventos de validação
				document.getElementById("dataNascimento").addEventListener("change", validarDatas);
				document.getElementById("anoCirurgia").addEventListener("change", validarDatas);
				document.getElementById("mesCirurgia").addEventListener("change", validarDatas);

				// Validação inicial
				validarDatas();
			});
		</script>
		<script>
			document.addEventListener("DOMContentLoaded", function () {
				const anoCirurgiaSelect = document.getElementById("anoCirurgia");
				const dataNascimentoInput = document.getElementById("dataNascimento");
				const erroAno = document.getElementById("erroAnoCirurgia");

				function validarAnoCirurgia() {
					const anoCirurgia = parseInt(anoCirurgiaSelect.value);
					const dataNascimento = new Date(dataNascimentoInput.value);
					const anoNascimento = dataNascimento.getFullYear();

					if (!isNaN(anoCirurgia) && !isNaN(anoNascimento)) {
						if (anoCirurgia <= anoNascimento) {
							erroAno.style.display = "block";
						} else {
							erroAno.style.display = "none";
						}
					}
				}

				anoCirurgiaSelect.addEventListener("change", validarAnoCirurgia);
				dataNascimentoInput.addEventListener("change", validarAnoCirurgia);
			});
		</script>

		<script>
			document.getElementById("calcularBtn").addEventListener("click", async function () {

				// Recolhe os dados do formulário
				const generoSelecionado = document.querySelector('input[name="genero"]:checked')?.value;
				const dataNascimento = document.getElementById("dataNascimento").value;
				const anoCirurgia = document.getElementById("anoCirurgia").value;
				const mesCirurgia = document.getElementById("mesCirurgia").value;
				const peso = parseFloat(document.getElementById("peso").value);
				const peso_max = parseFloat(document.getElementById("peso_max").value);
				const altura = parseFloat(document.getElementById("altura").value);
                const imcInicial = peso / (altura ** 2);
                if (imcInicial < 30) {
                    document.getElementById("erroIMCInicial").style.display = "block";
                    document.getElementById("resultado").style.display = "none";
                    return; // Impede o cálculo dos gráficos e a chamada à API
                } else {
                    document.getElementById("erroIMCInicial").style.display = "none";
                }

				const cirurgia = document.querySelector('input[name="cirurgiaRealizada"]:checked');

				document.getElementById("mensagemErro").style.display = "none";

				const camposAntecedentes = [
					"hta", "diabetes", "sono", "dislipidemia", "cardiopatia",
					"psiquiatrica", "osteomuscular", "drge", "hiperuricemia", "insulina"
				];

				const todosAntecedentesPreenchidos = camposAntecedentes.every(nome =>
					document.querySelector(`input[name="${nome}"]:checked`)
				);

				// Validar campos adicionais SE cirurgia foi realizada
				let camposAdicionaisPreenchidos = true;
				if (cirurgia && cirurgia.value === "sim") {
					const peso3meses = document.getElementById("peso3meses").value;
					if (!peso3meses) {
						camposAdicionaisPreenchidos = false;
					}
				}

				if (
					generoSelecionado &&
					dataNascimento &&
					anoCirurgia &&
					mesCirurgia &&
					peso_max &&
					peso &&
					altura &&
					todosAntecedentesPreenchidos &&
					cirurgia &&
					camposAdicionaisPreenchidos
				) {
					document.getElementById("resultado").style.display = "block";					
				} else {
					document.getElementById("resultado").style.display = "none";
					document.getElementById("mensagemErro").style.display = "block";
				}


				const Género = generoSelecionado === "feminino" ? 0 : 1;
				// console.log("Género:", generoSelecionado, Género);

				// Cálculo da Idade_Cirurgia_anos
				function calcularIdadeNaCirurgia(dataNascimento, anoCirurgia, mesCirurgia) {
					const dataNasc = new Date(dataNascimento);
					if (isNaN(dataNasc.getTime())) return null;

					const meses = {
						"janeiro": 0, "fevereiro": 1, "marco": 2, "abril": 3,
						"maio": 4, "junho": 5, "julho": 6, "agosto": 7,
						"setembro": 8, "outubro": 9, "novembro": 10, "dezembro": 11
					};
					const mesNumero = meses[mesCirurgia.toLowerCase()];

					const dataCirurgia = new Date(anoCirurgia, mesNumero, 1);
					if (isNaN(dataCirurgia.getTime())) return null;

					let idade = dataCirurgia.getFullYear() - dataNasc.getFullYear();
					if (dataCirurgia.getMonth() < dataNasc.getMonth() ||
						(dataCirurgia.getMonth() === dataNasc.getMonth() && dataCirurgia.getDate() < dataNasc.getDate())) {
						idade--;
					}
					return idade;
				}

				Idade_Cirurgia_anos = calcularIdadeNaCirurgia(dataNascimento, anoCirurgia, mesCirurgia);

				const IMC_inicial = peso / (altura ** 2);
				const Var_Peso_max = peso_max - peso;
				const antecedentes = [
					"diabetes", "hta", "dislipidemia", "sono", "cardiopatia",
					"psiquiatrica", "osteomuscular", "drge", "hiperuricemia", "insulina"
				].map(nome => document.querySelector(`input[name = "${nome}"]:checked`)?.value === "sim" ? 1 : 0);

				let DM = antecedentes[0];
				let HTA = antecedentes[1];
				let Dislipidemia = antecedentes[2];
				let SAOS_DPOC = antecedentes[3];
				let Cardiopatia = antecedentes[4];
				let Pert_Psiquiatrica = antecedentes[5];
				let Doenca_osteomuscular = antecedentes[6];
				let DRGE = antecedentes[7];
				let Hiperuricemia = antecedentes[8];
				let Insulina = antecedentes[9];

				const Soma_antecedentes = antecedentes.reduce((a, b) => a + b, 0);
				const Idade_Comorb = Soma_antecedentes * Idade_Cirurgia_anos;


				// Se a cirurgia foi realizada, recolhe os pesos reais aos 3, 6, etc. meses
				let pesosMeses = [];
				if (cirurgia === "sim") {
					pesosMeses = [
						"peso3meses", "peso6meses", "peso12meses", "peso24meses", "peso36meses", "peso48meses", "peso60meses"
					].map(id => parseFloat(document.getElementById(id)?.value) || null);

				}

                // Função para calcular variações do IMC entre períodos dos pesos conhecidos
                function calcularVariacoesIMC(pesoInicial, altura, pesosMeses) {
                    const imcInicial = pesoInicial / (altura ** 2);
                    const variacoes = {
                        variacao_imc_0_3: null,
                        variacao_imc_3_6: null,
                        variacao_imc_6_12: null,
                        variacao_imc_12_24: null,
                        variacao_imc_24_36: null,
                        variacao_imc_36_48: null,
                        variacao_imc_48_60: null
                    };

                    // Calcula IMC para cada peso pós-cirurgia
                    const imcPostCirurgia = pesosMeses.map(peso => {
                        return peso !== null ? (peso / (altura ** 2)) : null;
                    });

                    
                    if (pesosMeses[0] !== null) variacoes.variacao_imc_0_3 = imcPostCirurgia[0] - imcInicial;
                    if (pesosMeses[1] !== null && pesosMeses[0] !== null) variacoes.variacao_imc_3_6 = imcPostCirurgia[1] - imcPostCirurgia[0];
                    if (pesosMeses[2] !== null && pesosMeses[1] !== null) variacoes.variacao_imc_6_12 = imcPostCirurgia[2] - imcPostCirurgia[1];
                    if (pesosMeses[3] !== null && pesosMeses[2] !== null) variacoes.variacao_imc_12_24 = imcPostCirurgia[3] - imcPostCirurgia[2];
                    if (pesosMeses[4] !== null && pesosMeses[3] !== null) variacoes.variacao_imc_24_36 = imcPostCirurgia[4] - imcPostCirurgia[3];
                    if (pesosMeses[5] !== null && pesosMeses[4] !== null) variacoes.variacao_imc_36_48 = imcPostCirurgia[5] - imcPostCirurgia[4];
                    if (pesosMeses[6] !== null && pesosMeses[5] !== null) variacoes.variacao_imc_48_60 = imcPostCirurgia[6] - imcPostCirurgia[5];

                    return variacoes;
                }

				// Se a cirurgia foi realizada - variações do imc dos pesos conhecidos dos doentes
				let variacoesIMC = {};
				if (cirurgia?.value === "sim") {
					// Recolhe pesos pós-cirurgia
					const pesosMeses = [
						"peso3meses", "peso6meses", "peso12meses",
						"peso24meses", "peso36meses", "peso48meses", "peso60meses"
					].map(id => {
						const valor = document.getElementById(id)?.value;
						return valor ? parseFloat(valor) : null;
					});

					// Calcula variações do IMC
					variacoesIMC = calcularVariacoesIMC(
						parseFloat(document.getElementById("peso").value),
						parseFloat(document.getElementById("altura").value),
						pesosMeses
					);
				}

				// Prepara os dados para enviar para a API Python
                const paciente = {
                    "Género": Género,
                    "Idade_Cirurgia_anos": Idade_Cirurgia_anos,
                    "IMC_inicial": IMC_inicial,
                    "Var_Peso_max": Var_Peso_max,
                    "DM": DM,
                    "HTA": HTA,
                    "Dislipidemia": Dislipidemia,
                    "SAOS_DPOC": SAOS_DPOC,
                    "Cardiopatia": Cardiopatia,
                    "Pert_Psiquiatrica": Pert_Psiquiatrica,
                    "Doenca_osteomuscular": Doenca_osteomuscular,
                    "DRGE": DRGE,
                    "Hiperuricemia": Hiperuricemia,
                    "Insulina": Insulina,
                    "Soma_antecedentes": Soma_antecedentes,
                    "Idade_Comorb": Idade_Comorb
                };

				const conhecidos = {
					"Var_IMC_0_3": variacoesIMC.variacao_imc_0_3,
					"Var_IMC_3_6": variacoesIMC.variacao_imc_3_6,
					"Var_IMC_6_12": variacoesIMC.variacao_imc_6_12,
					"Var_IMC_12_24": variacoesIMC.variacao_imc_12_24,
					"Var_IMC_24_36": variacoesIMC.variacao_imc_24_36,
					"Var_IMC_36_48": variacoesIMC.variacao_imc_36_48,
					"Var_IMC_48_60": variacoesIMC.variacao_imc_48_60
				};

				console.log("conhecidos:", conhecidos);

				try {
					const resposta = await fetch('http://localhost:5000/predict', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ paciente, conhecidos })

					});

					if (!resposta.ok) throw new Error('Erro ao chamar a API');

					const resultado = await resposta.json();

					console.log('Modelo utilizado:', resultado.modelo);
					console.log('Previsão:', resultado.resultado);

					const imcInicial = peso / (altura ** 2);

					const ordem = [
						"Var_IMC_0_3", "Var_IMC_3_6", "Var_IMC_6_12", "Var_IMC_12_24",
						"Var_IMC_24_36", "Var_IMC_36_48", "Var_IMC_48_60"
					];
					const variacoes = ordem.map(k => resultado.resultado[k]);

					// console.log("IMC Inicial:", imcInicial);

					// Construir a projeção de IMC acumulando as variações
					const imcProjecao = [];
					let imcAtual = imcInicial;
					imcProjecao.push(parseFloat(imcAtual.toFixed(2)));
					for (let i = 0; i < variacoes.length; i++) {
						imcAtual += variacoes[i];
						imcProjecao.push(parseFloat(imcAtual.toFixed(2)));
					}

					// Converte cada IMC em peso
					const pesosProj = imcProjecao.map(imc => parseFloat((imc * (altura ** 2)).toFixed(1)));

					const labels = [
					"0 meses", "3 meses", "6 meses", "12 meses",
					"24 meses", "36 meses", "48 meses", "60 meses",
					];

					document.getElementById("resultado").style.display = "block";
					mostrarGraficoPesos(labels, pesosProj, peso, altura);

					// alert('Previsão recebida! Veja o resultado no console.');
				} catch (erro) {
					console.error('Erro:', erro);
					alert('Erro ao obter previsão: ' + erro.message);
				}
			});

		</script>
</body>
